<ALL> #--------------------------------------------------------------------*
<ALL> #
<ALL> # Developed by;
<ALL> #      Neal Horman - http://www.wanlink.com
<ALL> #
<ALL> #      CVS:  $Id: Makefile.tmpl,v 1.58 2014/12/31 00:51:49 neal Exp $
<ALL> #
<ALL> # DESCRIPTION:
<ALL> #      Makefile
<ALL> #
<ALL> #--------------------------------------------------------------------*
<ALL>
#<ALL>CC =		gcc
<ALL>SRCS =		dns.c <WITH_DBL dbl.c> dnsbl.c hndlrs.c misc.c smisc.c mx.c smtp.c inet.c ifi.c bwlist.c badext.c dupe.c regexapi.c regexmisc.c md5api.c <WITH_ALIASES aliastable.c> <WITH_VIRTUSER virtusertable.c> <WITH_POPAUTH popauth.c><WITH_LIBSPF spfapi.c> <WITH_VASPRINTF nstring.c> <WITH_FWDHOSTCHK fwdhostlist.c> <WITH_GEOIP geoip.c> list.c <WITH_TABLE_FLATFILE table.c tableDriverFlatFile.c> <WITH_TABLE_PGSQL pgsql.c tableDriverPsql.c>
<NEED_LIBUTIL_LOCAL>SRCS +=		libutil/pidfile.c libutil/flopen.c
<Linux>SRCS +=		md5c.c md5hl.c
<Linux>SRCS +=		setproctitle.c
<ALL>OBJS =		${SRCS:.c=.o}
<ALL>INCLUDES =	${SRCS:.c=.h} spamilter.h <INC_OpenBSD ns_compat.h>
<ALL>
<ALL>WATCHERSRCS =	watcher.c
<ALL>WATCHEROBJS =	${WATCHERSRCS:.c=.o}
<ALL>WATCHERINCS =	${WATCHERSRCS:.c=.h}
<ALL>
<WITH_NSCOMPAT>NRSRCS =	ns_name.c ns_netint.c ns_parse.c
<WITH_NSCOMPAT>NROBJS =	${NRSRCS:.c=.o}
<ALL>
<RCFILEPATH>RCFILEPATH =		<X>
<ALL>CONFDIR =	/var/db/spamilter
<SMDIR>SMDIR =		<X>
<LIBSPFDIR>LIBSPFDIR =	<X>/lib
<LIBSPFDIR>LIBSPFINC =	<X>/src/libspf
<PKGLIBSPF>LIBSPF =	libspf.a
<LIBSPF2DIR>LIBSPFDIR =	<X>/libspf2/.libs
<LIBSPF2DIR>LIBSPFINC =	<X>/include
<PKGLIBSPF2>LIBSPF =	libspf2.a
<GEOIPDIR>LIBGEOIPDIR =	geoip/GeoIP-<X>.mod/libGeoIP/.libs
<GEOIPDIR>LIBGEOIPINC =	geoip/GeoIP-<X>.mod/libGeoIP
<PGSQLDIR>LIBPGSQLDIR = <X>/lib
<PGSQLDIR>LIBPGSQLINC = <X>/include
<PGSQLDIR>LIBPGSQL = -lpq -L${LIBPGSQLDIR} -I${LIBPGSQLINC}
<NOT_FreeBSD>SMOBJDIR =	${SMDIR}/obj.<SMOBJDIR>
<ALL>
<ALL>INCLUDEDIR =	-I. -I${SMDIR}/include <WITH_LIBSPF -I${LIBSPFINC}> <WITH_GEOIP -I${LIBGEOIPINC}>
<INCDIRS>INCLUDEDIR +=		<X>
<ALL>
<ALL>CFLAGS =		-Wall -pthread<INC_SunOS s>
<ALL>CFLAGS +=	-ggdb -g3
<WITH_GREYLIST>CFLAGS += -I/usr/local/psql/include
<SUPPORTTABLEPGSQL>CFLAGS += -I/usr/local/psql/include
<CFLAGS>CFLAGS +=	<X>
<OFLAGS>OFLAGS =	<X>
<ALL>LDFLAGS =	
<ALL>
<ALL>LIBS =		-lmilter -lutil
<BSD>LIBS +=	-lmd
<Linux>LIBS +=		-lsmutil -lresolv -ldb
<SunOS>LIBS +=		-lsmutil -lresolv -lsocket -lnsl -lxnet -lpthread
<LIBS>LIBS +=		<X>
<ALL>LIBDIRS =
<BSD>LIBDIRS +=	-L${SMDIR}/libmilter
<NOT_BSD>LIBDIRS +=	-L${SMOBJDIR}/libmilter -L${SMOBJDIR}/libsmutil -L/usr/lib
<LIBDIRS>LIBDIRS +=	<X>
<ALL>
<ALL>BINDIR =		/usr/local/bin
<ALL>BINOWN =		bin
<ALL>BINGRP =		bin
<ALL>BINMODE =	0555
<ALL>
<FreeBSD>RCDIR =		/usr/local/etc/rc.d
<FreeBSD>RCSHELL =	spamilter
<FreeBSD>RCMODE =		0754
<ALL>
<ALL>all: spamilter dnsblchk <INC_FreeBSD dnsblupd> mxlookup iflookup ipfwmtad <WITH_GREYLIST greydbd>
<ALL>	${MAKE} -C ../docs/man
<ALL>
<ALL>uninstall: uninstall-man
<ALL>	rm -f ${BINDIR}/spamilter ${BINDIR}/dnsblchk <INC_FreeBSD ${BINDIR}/dnsblupd> ${BINDIR}/mxlookup ${BINDIR}/ipfwmtad <INC_FreeBSD ${RCDIR}/${RCSHELL}> <WITH_GREYLIST ${BINDIR}/greydbd>
<ALL>	echo "Files in ${CONFDIR} and ${RCFILEPATH} have been left in place, you'll need to remove them if you don't want them anymore."
<ALL>
<ALL>distclean: clean
<ALL>	rm -f Makefile
<GEOIPDIR>	rm -rf geoip/.built geoip/GeoIP-<X>.mod
<PKGLIBSPF>	rm -rf libspf/.built libspf/build
<PKGLIBSPF2>	rm -rf libspf/.built libspf/build2
<ALL>
<ALL>clean:
<ALL>	rm -f ${OBJS} *core spamilter dnsblchk <INC_FreeBSD dnsblupd> mxlookup iflookup ipfwmtad <WITH_GREYLIST greydbd>
<ALL>	${MAKE} -C ../docs/man clean
<ALL>
<ALL>install: install-spamilter install-dnsblchk <INC_FreeBSD install-dnsblupd> install-mxlookup install-ipfwmtad <INC_FreeBSD install-startup> <WITH_GREYLIST install-greydbd> install-config install-man
<ALL>
<ALL>install-spamilter: spamilter
<ALL>	install -c -m ${BINMODE} -g ${BINGRP} -o ${BINOWN} spamilter ${BINDIR}
<ALL>
<ALL>install-dnsblchk: dnsblchk
<ALL>	install -c -m ${BINMODE} -g ${BINGRP} -o ${BINOWN} dnsblchk ${BINDIR}
<ALL>
<FreeBSD>install-dnsblupd: dnsblupd
<FreeBSD>	install -c -m ${BINMODE} -g ${BINGRP} -o ${BINOWN} dnsblupd ${BINDIR}
<FreeBSD>
<ALL>install-mxlookup: mxlookup
<ALL>	install -c -m ${BINMODE} -g ${BINGRP} -o ${BINOWN} mxlookup ${BINDIR}
<ALL>
<ALL>install-ipfwmtad: ipfwmtad
<ALL>	install -c -m 0500 -g ${BINGRP} -o ${BINOWN} ipfwmtad ${BINDIR}
<ALL>
<ALL><WITH_GREYLIST install-greydbd: greydbd>
<ALL><WITH_GREYLIST 	install -c -m ${BINMODE} -g ${BINGRP} -o ${BINOWN} greydbd ${BINDIR}>
<ALL>
<FreeBSD>install-startup:
<FreeBSD>	if [ ! -e ${RCDIR}/*${RCSHELL}* ]; then install -c -m ${RCMODE} -g ${BINGRP} -o ${BINOWN} ../rc.d/${RCSHELL} ${RCDIR}; fi
<FreeBSD>
<ALL>install-config:
<ALL>	if [ ! -d ${CONFDIR} ]; then \
<ALL>		install -p -m 0664 ../conf/spamilter.rc ${RCFILEPATH}; \
<ALL>		install -d -C -m 0664 ${CONFDIR}; \
<ALL>		for i in db.extensions db.fwdhost db.geocc db.rcpt db.rdnsbl db.sndr; do \
<ALL>			install -p -m 0664 ../conf/$${i} ${CONFDIR}; \
<ALL>		done; \
<GEOIPDIR>		install -d -C -m 0664 ${CONFDIR}/geoip; \
<GEOIPDIR>		install -p -m 0754 ../conf/geoip/fetchgeoip.sh ${CONFDIR}/geoip; \
<GEOIPDIR>		if [ ! -e ${CONFDIR}/geoip/GeoIP.dat ]; then ${CONFDIR}/geoip/fetchgeoip.sh; fi; \
<FreeBSD>		install -d -C -m 0664 /usr/local/etc/newsyslog.conf.d; \
<FreeBSD>		install -p -m 0754 ../conf/geoip/spamilter.newsyslog /usr/local/etc/newsyslog.conf.d; \
<FreeBSD>		if [ ! -e /var/log/spam.log ]; then touch /var/log/spam.log && chmod 0644 /var/log/spam.log; fi; \
<FreeBSD>		if [ ! -e /var/log/spam.info ]; then touch /var/log/spam.info && chmod 0644 /var/log/spam.info; fi; \
<FreeBSD>		if [ -z "`grep Spamilter /etc/syslog.conf`" ]; then echo -e '\n!Spamilter\n*.info\t/var/log/spam.log\n*.<>info\t/var/log/spam.info\n' >> /etc/syslog.conf && service syslogd restart; fi; \
<FreeBSD>		if [ ! -e /var/log/greydbd.log ]; then touch /var/log/greydbd.log && chmod 0644 /var/log/greydbd.log; fi; \
<FreeBSD>		if [ -z "`grep greydbd /etc/syslog.conf`" ]; then echo -e '\n!greydbd\n*.*\t/var/log/greydbd.log\n' >> /etc/syslog.conf && service syslogd restart; fi; \
<ALL>	fi
<ALL>
<ALL>install-man:
<ALL>	${MAKE} -C ../docs/man install
<ALL>
<ALL>uninstall-man:
<ALL>	${MAKE} -C ../docs/man uninstall
<ALL>
<ALL>tar: clean
<ALL>#	cd ..; tar --exclude CVS -cvzf spamilter.tgz spamilter/*
<ALL>	tar -C .. -Ttgz.lst -czf ../spamilter.tgz
<ALL>
<PKGGEOIP>${LIBGEOIPDIR}/libGeoIP.a:
<PKGGEOIP>	cd geoip && ./build.sh
<PKGGEOIP>
<PKGLIBSPF>${LIBSPFDIR}/${LIBSPF}:
<PKGLIBSPF>	cd libspf && ./build.sh
<PKGLIBSPF>
<PKGLIBSPF2>${LIBSPFDIR}/${LIBSPF}:
<PKGLIBSPF2>	cd libspf && ./build2.sh
<PKGLIBSPF2>
<ALL>spamilter: Makefile <WITH_GEOIP ${LIBGEOIPDIR}/libGeoIP.a> <WITH_LIBSPF ${LIBSPFDIR}/${LIBSPF}> ${WATCHERSRCS} ${SRCS} <WITH_NSCOMPAT ${NRSRCS}> spamilter.o ${WATCHEROBJS} ${OBJS} <WITH_NSCOMPAT ${NROBJS}> ${INCLUDES} ${WATCHERINCS}
<ALL>	${CC} ${CFLAGS} -o spamilter spamilter.o ${WATCHEROBJS} ${OBJS} <WITH_NSCOMPAT ${NROBJS}> <WITH_LIBSPF ${LIBSPFDIR}/${LIBSPF}> <WITH_GEOIP ${LIBGEOIPDIR}/libGeoIP.a> ${LIBDIRS} ${LIBS} <WITH_TABLE_PGSQL ${LIBPGSQL}>
<ALL>
<ALL>dnsblchk: Makefile ${SRCS} <WITH_NSCOMPAT ${NRSRCS}> <WITH_VASPRINTF nstring.c> dnsblchk.o ${OBJS} <WITH_NSCOMPAT ${NROBJS}> <WITH_VASPRINTF nstring.o> ${INCLUDES} dnsblchk.c
<ALL>	${CC} ${CFLAGS} -o dnsblchk dnsblchk.o dnsbl.o dns.o smisc.o misc.o mx.o smtp.o inet.o ifi.o <WITH_NSCOMPAT ${NROBJS}> <WITH_VASPRINTF nstring.o> ${LIBDIRS} ${LIBS}
<ALL>
<FreeBSD># dnsblupd is for use with the companion shell script blupd as an Exec action
<FreeBSD>dnsblupd: Makefile dnsblupd.c dnsupdate.c dns.c dnsblupd.o dnsupdate.o dns.o  dnsupdate.h dns.h config.h misc.o misc.h <WITH_NSCOMPAT ${NRSRCS} ${NROBJS}>
<FreeBSD>	${CC} ${CFLAGS} -o dnsblupd dnsblupd.o dnsupdate.o dns.o misc.o <WITH_NSCOMPAT ${NROBJS}> ${LIBDIRS} ${LIBS}
<FreeBSD>
<ALL>ipfwmtad: Makefile ipfwmtad.c <INC_FreeBSD ipfw_direct.c> inet.c misc.c <WITH_PAM pam.o> uam.o ipfwmtad.o <INC_FreeBSD ipfw_direct.o> inet.o misc.o <WITH_PAM pam.o> uam.o key.o inet.h misc.h <WITH_PAM pam.h> uam.h key.h config.h
<ALL>	${CC} ${CFLAGS} -o ipfwmtad ipfwmtad.o <INC_FreeBSD ipfw_direct.o> inet.o misc.o <WITH_PAM pam.o> uam.o key.o <WITH_PAM -lpam> -lcrypto -lcrypt
<ALL>
<ALL>mxlookup: Makefile mxlookup.c mx.c <WITH_NSCOMPAT ${NRSRCS}> mxlookup.o mx.o mx.h dns.o dns.h misc.o misc.h <WITH_NSCOMPAT ${NROBJS}>
<ALL>	${CC} ${CFLAGS} -o mxlookup mxlookup.o mx.o dns.o misc.o ${LIBDIRS} ${LIBS} <WITH_NSCOMPAT ${NROBJS}> <NOT_BSD -lresolv>
<ALL>	
<ALL>iflookup: Makefile iflookup.c ifi.c iflookup.o ifi.o ifi.h
<ALL>	${CC} ${CFLAGS} -o iflookup iflookup.o ifi.o ${LIBDIRS} ${LIBS}
<ALL>
<PKGGREYLIST>greydbd: Makefile greydbd.o inet.o inet.h pgsql.o pgsql.h md5api.o md5api.h misc.o misc.h config.h
<PKGGREYLIST>	${CC} ${CFLAGS} -o greydbd greydbd.o inet.o pgsql.o md5api.o misc.o -lmd ${LIBPGSQL}
<SUPPORTTABLEFLAT>
<SUPPORTTABLEFLAT>bwlist_flat: Makefile bwlist.c table.c tableDriverFlatFile.c list.c misc.c
<SUPPORTTABLEFLAT>	${CC} -ggdb -g3 -DSUPPORT_TABLE_FLATFILE -DUNIT_TEST -o bwlist_flat bwlist.c table.c tableDriverFlatFile.c list.c misc.c
<SUPPORTTABLEPGSQL>
<SUPPORTTABLEPGSQL>bwlist_pgsql: Makefile bwlist.c table.c tableDriverPgsql.c list.c misc.c pgsql.c
<SUPPORTTABLEPGSQL>	${CC} -ggdb -g3 -DSUPPORT_TABLE_PGSQL -DUNIT_TEST -o bwlist_pgsql bwlist.c table.c tableDriverPsql.c list.c misc.c pgsql.c ${LIBPGSQL}
<ALL>
<ALL>.c.o: Makefile ${INCLUDES}
<ALL>	${CC} ${CFLAGS} ${OFLAGS} ${INCLUDEDIR} -c $< -o $@
